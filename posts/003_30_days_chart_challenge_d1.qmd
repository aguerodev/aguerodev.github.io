---
title: "30 days chart challenge 1/30"
description: " "
author: "<a href = 'www.linkedin.com/in/carlos-aguero-cr' style = 'text-decoration: underline;'>Carlos Aguero B.</a>"
date: 2024-04-01
date-modified: "`r Sys.Date()`"
categories: ['Borrador','Guías Paso a Paso', 'ggplot2','#30DayChartChallenge']
lang: "es"
image: images/portada_d1.png
comments:
  utterances:
    repo: aguerodev/aguerodev.github.io
toc: true
code-line-numbers: true
code-copy: true
toc-location: left
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dpi = 400,
                      fig.width = 8.51, fig.height = 11.3)

```

::: {.callout-warning appearance="simple"}
Hola a todos!! una pequeña advertencia: este documento aún está en construcción. Puedes intentar utilizarlo, pero ten en cuenta que algunas cosas aún podrían no funcionar bien. Recomiendo esperar a la versión final.
:::




```{r}
library(tidyverse)
library(rvest)
library(janitor)
library(waffle)
library(glue)
library(ggtext)
```


```{r}
df <- tibble::tribble(
  ~"provincia", ~"url",
  "San José", "https://www.tse.go.cr/juris/relevantes/1658-E11-2024.html",
  "Alajuela", "https://www.tse.go.cr/juris/relevantes/2156-E11-2024.html",
  "Cartago", "https://www.tse.go.cr/juris/relevantes/2157-E11-2024.html",
  "Heredia", "https://www.tse.go.cr/juris/relevantes/2158-E11-2024.html",
  "Guanacaste", "https://www.tse.go.cr/juris/relevantes/2159-E11-2024.html",
  "Puntarenas", "https://www.tse.go.cr/juris/relevantes/2160-E11-2024.html",
  "Limón", "https://www.tse.go.cr/juris/relevantes/2161-E11-2024.html"
  )
```

```{r}
resultados <- map(transpose(df), \(x){
  read_html(x$url) |> 
  html_table(na.strings = "-", trim = TRUE, header = TRUE) |> 
  map(\(x){
    x |> 
      pivot_longer(
        cols = -`PARTIDO POLÍTICO`,
        names_to = "canton",
        values_to = "votos",
        ) |> 
      clean_names() |> 
      mutate(
        votos = parse_number(votos, locale = locale(grouping_mark = " ")),
        canton = str_to_title(canton),
        partido_politico = str_squish(partido_politico),
        partido_politico = str_to_title(partido_politico)
      ) |> 
      filter(
        partido_politico != "Total Votos Válidos"
      ) |> 
      drop_na() |> 
      select(canton, partido_politico, votos)
  }) |> 
    list_rbind() |> 
    add_column(
      provincia = x$provincia,
      .before = 1
    )
}) |> 
  list_rbind()
```



```{r}
df_plot <- resultados |> 
  mutate(
    p = votos/sum(votos),
    .by = c(canton)
  ) |> 
  filter(
    canton == "San José"
  ) |> 
  mutate(
    n = round(p*100),
    color = "partido",
    partido_politico = str_wrap(partido_politico, 15),
    partido_politico = str_replace(partido_politico, "\\n","<br>"),
    partido_politico = fct_lump_lowfreq(
      partido_politico,
      w = votos,
      other_level = "Otros"
    ),
    partido_politico = glue("<b>{partido_politico}</b> ({n}%)"),
    partido_politico = fct_reorder(partido_politico, votos, .desc = TRUE)
  )|> 
  group_by(canton, partido_politico) |> 
  group_modify(~ add_row(.x, n = 100-.x$n, color = "todos"))
```




```{r}
ggplot(
  data = df_plot, 
  aes(fill = color, values = n)
) +
  geom_waffle(
    color = "white", 
    size = .8, 
    n_rows = 10,
    flip = TRUE
  ) +
  facet_wrap(~partido_politico) +
  scale_fill_manual(
    values = c(
      "partido" = "#FFCC70",
      "todos" = "#E3E1D9"
    ),
    labels = c("Votos del partido","Total de votos")
  ) +
  labs(
    title = "Resultados electorales municipales",
    subtitle = "Porcentaje de votos por partido político para el cantón\nde San José, Costa Rica, 2024.",
    fill = "",
    caption = "Fuente: Tribunal Supremo de Elecciones") +
  coord_equal() +
  theme_void() +
  theme(
    plot.title = element_text(
      size = 18,
      face = "bold",
      family = "Roboto"
    ), 
    legend.text = element_text(size = 16),
    legend.box.margin = margin(b = 10),
    plot.subtitle = element_text(
      size = 16
    ),
    strip.text = element_markdown(
      hjust = 0,
      margin = margin(l = 5),
      size = 12,
      vjust = 0
    ),
    legend.position = "top",
    legend.justification = "left",
    legend.margin = margin(t = 20),
    plot.margin = margin(5,b = 10,5,5)
  )
```

```{r}
ggsave("plot_elecciones_d1.jpg", dpi = 400, width = 8.51, height = 11.3)
```


