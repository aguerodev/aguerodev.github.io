{
  "hash": "4b46ce58a31f519f53a563bad79f4dcd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Manipulando el mapa de los cantones y distritos de Costa Rica con R\"\ndescription: \"Trabajar con datos geoespaciales anteriores a 2017 a menudo resulta en mapas con espacios vacíos o zonas grises, debido a cambios en fronteras, actualización de códigos o datos ausentes. Este tutorial muestra cómo resolver estos problemas y unir regiones usando el paquete ‘sf’.\"\ndate: 2024-05-29\ncategories: ['Guías Paso a Paso', 'ggplot2','sf','dplyr']\nlang: \"es\"\nimage: images/mapa47.png\ncomments:\n  utterances:\n    repo: quarto-dev/quarto-docs\ntoc: true\ncode-line-numbers: true\ncode-copy: true\ntoc-location: left\neditor_options: \n  chunk_output_type: console\nexecute: \n  freeze: true\nauthor:\n  - name: Carlos Aguero\n    affiliation: Aprende Tidyverse\n    affiliation-url: https://aprendetidyverse.com/\ncitation: true\nformat:\n  html:\n    other-links:\n      - text: Descargar archivos geoJSON\n        href: https://share.aprendetidyverse.com/s/info_mapas_post2\n\n---\n\n\n\n\n\n\nHace un par de semanas, en [nuestras sesiones de consultas los domingos a las 6 p.m.](https://aprendetidyverse.com/lunes_pr.html), nos plantearon el siguiente problema: **¿qué pasa si, al descargar el mapa actualizado, como vimos en el [post anterior](https://aprendetidyverse.com/posts/001_mapa_cantones_cr.html), mis datos no están actualizados?** Dicho de otra forma, en mi mapa existen los nuevos cantones como Río Cuarto, Puerto Jiménez y Monteverde, pero no en mis datos, y esas zonas aparecerán en gris. Bueno, en esta guía veremos paso a paso cómo regresar el mapa a la forma que tenía en 2017, uniendo estos nuevos cantones al cantón al que pertenecían, y así poder visualizar nuestro mapa sin regiones sin datos. Esto nos servirá también para crear nuestras propias agrupaciones de áreas, por ejemplo, un mapa de las regiones socioeconómicas de Costa Rica.\n\nPuedes descargar los datos de los cantones y distritos en este [enlace](https://share.aprendetidyverse.com/s/info_mapas_post2)\n\n# Unir cantones\n\n## Paso 1: Cargar nuestros datos\n\nEn este caso, asumiremos que ya leíste y ejecutaste lo visto en [**Actualizando el mapa de cantones de Costa Rica con R**](https://aprendetidyverse.com/posts/001_mapa_cantones_cr.html), así que importaremos directamente el archivo `cantones.geojson`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(readxl)\nlibrary(sf)\nlibrary(janitor)\n\ncantones <- read_sf(\"cantones.geojson\") |> \n  clean_names() |> \n  mutate(codigo_canton = as.character(codigo_canton))\n\nglimpse(cantones)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 84\nColumns: 5\n$ codigo_de_provincia <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…\n$ canton              <chr> \"San José\", \"Escazú\", \"Desamparados\", \"Puriscal\", …\n$ provincia           <chr> \"San José\", \"San José\", \"San José\", \"San José\", \"S…\n$ codigo_canton       <chr> \"101\", \"102\", \"103\", \"104\", \"105\", \"106\", \"107\", \"…\n$ geometry            <MULTIPOLYGON [°]> MULTIPOLYGON (((-84.15569 9..., MULTI…\n```\n\n\n:::\n:::\n\n\n\nPor otro lado, utilizaremos los datos del [IDS de Mideplan de 2017](https://documentos.mideplan.go.cr/share/s/T3CmePFRSdCAUc1q50kZQA), intencionalmente, para no tener datos para nuestros nuevos cantones.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nids <- read_excel(\n  path = \"IDS 2017.xlsx\",\n  sheet = \"IDS cantonal\",\n  skip = 2\n) |> \nclean_names() |> \nselect(codigo_canton = codigo, ids_2017)\n\nglimpse(ids)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 83\nColumns: 2\n$ codigo_canton <chr> \"102\", \"409\", \"407\", \"115\", \"408\", \"406\", \"118\", \"109\", …\n$ ids_2017      <dbl> 100.00000, 99.93229, 98.10882, 96.76766, 96.70938, 91.37…\n```\n\n\n:::\n:::\n\n\n\n## Paso 2: Unir nuestros datos\n\nEn este caso siempre debemos recordar como se menciona en [**Actualizando el mapa de cantones de Costa Rica con R**](https://aprendetidyverse.com/posts/001_mapa_cantones_cr.html) que debemos tener presente los posibles cambios de nombre de los cantones en el tiempo.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncantones <- left_join(cantones, ids)\nglimpse(cantones)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 84\nColumns: 6\n$ codigo_de_provincia <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…\n$ canton              <chr> \"San José\", \"Escazú\", \"Desamparados\", \"Puriscal\", …\n$ provincia           <chr> \"San José\", \"San José\", \"San José\", \"San José\", \"S…\n$ codigo_canton       <chr> \"101\", \"102\", \"103\", \"104\", \"105\", \"106\", \"107\", \"…\n$ geometry            <MULTIPOLYGON [°]> MULTIPOLYGON (((-84.15569 9..., MULTI…\n$ ids_2017            <dbl> 75.39888, 100.00000, 71.88500, 53.31167, 23.69962,…\n```\n\n\n:::\n:::\n\n\n\n## Paso 3: Visualizar nuestro mapa\n\nAhora que tenemos nuestros datos, vamos a crear un mapa donde representaremos en colores el IDS de cada cantón. Además, para identificarlos mejor, pondremos en <strong style = 'color:red;'>rojo</strong> aquellos cantones que no tengan datos, es decir, su IDS es NA.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(\n  data = cantones,\n  mapping = aes(\n    fill = ids_2017\n  )\n) +\n  geom_sf(color = \"white\", linewidth = 0.1) +\n  scale_fill_continuous(na.value = \"red\") +\n  theme_minimal() +\n  theme(\n    legend.position = \"bottom\"\n  )\n```\n\n::: {.cell-output-display}\n![](003_mapa_cantones_cr_p2_files/figure-html/unnamed-chunk-4-1.png){width=3200}\n:::\n:::\n\n\n\n\nPodemos ver a simple vista que tenemos 2 zonas en rojo, pero apliquemos un filtro para verlas con más claridad.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncantones |> \n  as.data.frame() |> \n  filter(if_any(everything(), is.na)) |> \n  select(provincia, canton,codigo_canton, ids_2017) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   provincia         canton codigo_canton ids_2017\n1 Puntarenas     Monteverde           612       NA\n2 Puntarenas Puerto Jiménez           613       NA\n```\n\n\n:::\n:::\n\n\n\nPodemos ver que efectivamente son los cantones de Puerto Jiménez[^puerto_jimenez] y Monteverde[^monteverde] los que no presentan datos.\n\n\n[^monteverde]: Delfino.cr. (25 de septiembre de 2019). Expediente 21618: Creación del Cantón de Monteverde, Cantón XII de la Provincia de Puntarenas. Delfino.cr. [Leer más](https://delfino.cr/asamblea/proyecto/21618)\n\n[^puerto_jimenez]: Delfino.cr. (21 de octubre de 2021). Expediente 22749: Creación del Cantón de Puerto Jiménez, Cantón XIII de la Provincia de Puntarenas. Delfino.cr. [Leer más](https://delfino.cr/asamblea/proyecto/22749)\n\nPara términos de nuestro ejemplo, vamos a \"regresar\" Monteverde al cantón de Puntarenas y Puerto Jiménez al cantón de Golfito.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncantones |> \n  as.data.frame() |> \n  filter(canton %in% c(\"Golfito\",\"Puntarenas\")) |> \n  select(canton, codigo_canton)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      canton codigo_canton\n1 Puntarenas           601\n2    Golfito           607\n```\n\n\n:::\n:::\n\n\n\n\n## Paso 3: Unificar nombre y códigos de los cantones a unir\n\nPara esto, debemos asegurarnos de que tanto el nombre del cantón como el código del cantón sean iguales para los cantones que queremos unir.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncantones <- read_sf(\"cantones.geojson\") |> \n  clean_names() |> \n  mutate(codigo_canton = as.character(codigo_canton))\n\n\ncantones <- cantones |> \n  mutate(\n    canton = case_match(\n      canton,\n      \"Puerto Jiménez\" ~ \"Golfito\",\n      \"Monteverde\" ~ \"Puntarenas\",\n      .default = canton\n    ),\n    codigo_canton = case_match(\n      codigo_canton,\n      \"613\" ~ \"607\",\n      \"612\" ~ \"601\",\n      .default = codigo_canton\n    )\n  )\n```\n:::\n\n\n\nAhora que tenemos los nombres correctos, podemos utilizar la función `st_union` para unificar esas regiones en un solo polígono.\n\n## Paso 4: Unimos los polígonos de las regiones que queremos 'reunificar'\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncantones <- cantones |> \n  group_by(codigo_de_provincia, provincia, codigo_canton, canton) |> \n  summarise(\n    geometry = st_union(geometry)\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`summarise()` has grouped output by 'codigo_de_provincia', 'provincia',\n'codigo_canton'. You can override using the `.groups` argument.\n```\n\n\n:::\n:::\n\n\n\nAhora realizamos el proceso anterior, unimos los datos del IDS y realizamos el gráfico.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncantones <- left_join(cantones, ids)\nglimpse(cantones)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 82\nColumns: 6\nGroups: codigo_de_provincia, provincia, codigo_canton [82]\n$ codigo_de_provincia <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…\n$ provincia           <chr> \"San José\", \"San José\", \"San José\", \"San José\", \"S…\n$ codigo_canton       <chr> \"101\", \"102\", \"103\", \"104\", \"105\", \"106\", \"107\", \"…\n$ canton              <chr> \"San José\", \"Escazú\", \"Desamparados\", \"Puriscal\", …\n$ geometry            <POLYGON [°]> POLYGON ((-84.15569 9.96885..., POLYGON ((…\n$ ids_2017            <dbl> 75.39888, 100.00000, 71.88500, 53.31167, 23.69962,…\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(\n  data = cantones,\n  mapping = aes(\n    fill = ids_2017\n  )\n) +\n  geom_sf(color = \"white\", linewidth = 0.1) +\n  scale_fill_continuous(na.value = \"red\") +\n  theme_minimal() +\n  theme(\n    legend.position = \"bottom\"\n  )\n```\n\n::: {.cell-output-display}\n![](003_mapa_cantones_cr_p2_files/figure-html/unnamed-chunk-10-1.png){width=3200}\n:::\n:::\n\n\n\nPara verificar que realmente hemos unificado los polígonos, veamos solamente el cantón de Golfito, en el que podemos ver a Puerto Jiménez (la de la izquierda para los que no conocen bien la geografía de la zona sur).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngolfo <- cantones |> \n  filter(canton == \"Golfito\")\n\nggplot(\n  data = golfo,\n  mapping = aes(\n    fill = ids_2017\n  )\n) +\n  geom_sf(color = \"white\", linewidth = 0.1) +\n  scale_fill_continuous(na.value = \"red\") +\n  theme_minimal() +\n  theme(\n    legend.position = \"bottom\"\n  )\n```\n\n::: {.cell-output-display}\n![](003_mapa_cantones_cr_p2_files/figure-html/unnamed-chunk-11-1.png){width=3200}\n:::\n:::\n\n\n\n# Unir distritos en regiones de planificación\n\nEn este ejemplo, utilizaremos los datos de los distritos y los agruparemos según su región administrativa en Costa Rica, que incluye Brunca, Central, Chorotega, Huetar Caribe, Huetar Norte y Pacífico Central.\n\n::: {.column-margin}\nLa Reforma de la División Regional del Territorio de Costa Rica, Decreto N° 9501, establece las regiones oficiales para la investigación y planificación del desarrollo socioeconómico [^decreto]\n\n[^decreto]: Costa Rica. Decreto Ejecutivo N° 9501. Reforma División Regional del Territorio de Costa Rica, para los Efectos de Investigación y Planificación del Desarrollo Socioeconómico. (11 de febrero de 2015). Procuraduría General de la República. [Leer más](https://www.pgrweb.go.cr/scij/Busqueda/Normativa/Normas/nrm_texto_completo.aspx?param1=NRTC&nValor1=1&nValor2=59730&nValor3=67054&strTipM=TC)\n:::\n\nPuedes descargar los datos de los cantones y distritos en este [enlace](https://share.aprendetidyverse.com/s/info_mapas_post2)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndistritos <- read_sf(\"distritos_cr.geojson\") |> \nclean_names()\n\nglimpse(distritos)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 491\nColumns: 16\n$ objectid         <int> 1131, 1132, 1133, 1134, 1135, 1136, 1137, 1138, 1139,…\n$ provincia        <chr> \"Limón\", \"Heredia\", \"Heredia\", \"Alajuela\", \"Heredia\",…\n$ canton           <chr> \"Pococí\", \"Sarapiquí\", \"Sarapiquí\", \"San Carlos\", \"Sa…\n$ region           <chr> \"Huetar Caribe\", \"Huetar Norte\", \"Huetar Norte\", \"Hue…\n$ oficializacion   <dttm> 1971-07-02, 1970-11-18, 1999-09-16, 1948-11-05, 1999…\n$ codigo_canton    <int> 702, 410, 410, 210, 410, 213, 210, 213, 214, 213, 214…\n$ global_id        <chr> \"{59F87CBA-7CA7-4E12-918D-822CB26FDB38}\", \"{96EC74A5-…\n$ distrito         <chr> \"Colorado\", \"Puerto Viejo\", \"Llanuras del Gaspar\", \"P…\n$ gml_id           <chr> \"limitedistrital_5k.1\", \"limitedistrital_5k.2\", \"limi…\n$ codigo           <int> 160105, 160105, 160105, 160105, 160105, 160105, 16010…\n$ codigo_provincia <int> 7, 4, 4, 2, 4, 2, 2, 2, 2, 2, 2, 5, 5, 5, 2, 6, 5, 6,…\n$ codigo_dta       <int> 70206, 41001, 41004, 21006, 41005, 21307, 21013, 2130…\n$ legislacion      <chr> \"Decreto  1825-G\", \"Ley 4671\", \"Decreto  28137-G\", \"D…\n$ area             <dbl> 948.43468, 428.51741, 267.21675, 379.26541, 369.70036…\n$ version          <dbl> 20240502001, 20240502001, 20240502001, 20240502001, 2…\n$ geometry         <MULTIPOLYGON [°]> MULTIPOLYGON (((-83.41636 1..., MULTIPOL…\n```\n\n\n:::\n:::\n\n\n\nSi realizamos un gráfico con los datos completos, veremos que se incluyen los 491 distritos de Costa Rica (a junio de 2024).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = distritos) +\n  geom_sf(color = \"white\", linewidth = 0.1, fill = \"steelblue\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](003_mapa_cantones_cr_p2_files/figure-html/unnamed-chunk-13-1.png){width=3200}\n:::\n:::\n\n\n\nAhora, podemos tomar este mapa y utilizar la función `st_union` junto con la variable `región` para crear un mapa de las regiones administrativas. Esto nos brinda mucha flexibilidad para adaptar los datos disponibles, permitiéndonos realizar las agrupaciones que mejor nos convengan.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nregiones <- distritos |> \n  group_by(region) |> \n  summarise(\n    geometry = st_union(geometry)\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(\n  data = regiones,\n  mapping = aes(\n    fill = region\n  )) +\n  geom_sf(color = \"white\", linewidth = 0.1) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](003_mapa_cantones_cr_p2_files/figure-html/unnamed-chunk-15-1.png){width=3200}\n:::\n:::\n\n\n\nEspero que esta pequeña guía te sea de utilidad. Si tienes alguna consulta, no dudes en contactarme a carlos.aguero@aprendetidyverse.com o unirte a nuestros [Domingos de Preguntas y Respuestas](https://aprendetidyverse.com/domingos_pr.html), un espacio público y gratuito donde conversamos y resolvemos juntos problemas con código R. Este espacio está diseñado para brindar acceso a toda la comunidad de usuarios de R, ofreciendo consultoría y apoyo en su proceso de aprendizaje sin costo alguno.",
    "supporting": [
      "003_mapa_cantones_cr_p2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}