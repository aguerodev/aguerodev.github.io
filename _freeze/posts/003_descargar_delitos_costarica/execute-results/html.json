{
  "hash": "72a3c621e6a2ba8eeb8f05e45cab09b2",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Automatizaci贸n de la descarga de datos de delitos en Costa Rica\"\ndescription: \"En este post aprenderemos c贸mo automatizar desde R la descarga, unificaci贸n y limpieza de datos sobre delitos en Costa Rica, obtenidos desde la plataforma del Poder Judicial.\"\ndate: 2025-03-04\ndate-modified: 2025-03-04\ncategories: [\"webscraping\", \"selenider\"] \nlang: \"es\"\nimage: images/oij.png\ntoc: true\ncode-line-numbers: true\ncode-copy: true\ntoc-location: left\nformat: html\neditor_options: \n  chunk_output_type: console\nexecute: \n  freeze: true\nauthor:\n  - name: Carlos Ag眉ero B\n    affiliation: Aprende Tidyverse\n    affiliation-url: https://aprendetidyverse.com/\ncitation: true\nbibliography: references.bib\n---\n\n\n\n<meta property=\"og:title\" content=\"Automatizaci贸n de la descarga de datos de delitos en Costa Rica\" />\n<meta property=\"og:description\" content=\"En este post aprenderemos c贸mo automatizar desde R la descarga, unificaci贸n y limpieza de datos sobre delitos en Costa Rica, obtenidos desde la plataforma del Poder Judicial.\" />\n<meta property=\"og:type\" content=\"video.other\" />\n<meta property=\"og:url\" content=\"https://aprendetidyverse.com/automatizacion-delitos\" />\n<meta property=\"og:image\" content=\"https://aprendetidyverse.com/images/oij.png\" />\n<meta property=\"og:site_name\" content=\"Aprende Tidyverse\" />\n<meta property=\"og:locale\" content=\"es_ES\" />\n\n<meta property=\"article:published_time\" content=\"2025-03-04T00:00:00+00:00\" />\n<meta property=\"article:modified_time\" content=\"2025-03-04T00:00:00+00:00\" />\n\n<!-- Open Graph Video Preview -->\n<meta property=\"og:video\" content=\"https://player.vimeo.com/video/710119524?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479\" />\n<meta property=\"og:video:secure_url\" content=\"https://player.vimeo.com/video/710119524?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479\" />\n<meta property=\"og:video:type\" content=\"text/html\" />\n<meta property=\"og:video:width\" content=\"1280\" />\n<meta property=\"og:video:height\" content=\"720\" />\n\n## Introducci贸n: 驴Por qu茅 hacer esto?\n\nTodos los d铆as escuchamos en las noticias acerca del incremento en los homicidios y la inseguridad en Costa Rica. Por un lado, la dice que la inseguridad est谩 fatal, por otro, algunos sostienen que \"es solo percepci贸n\" y que \"se matan entre ellos\" (refiri茅ndose a los delincuentes). Entre tantos *dimes y diretes*, creo que este extracto del libro la sociedad del cansancio representa c贸mo nos podemos sentir.\n\n> En la era digital, el exceso de informaci贸n nos satura hasta el punto de la apat铆a; el bombardeo constante de datos nos impide distinguir lo esencial y nos sumerge en un estado de desconfianza generalizada. @han2012\n\nVeamos algunos de esas noticias: \n\n<br>\n<div class=\"iframely-embed\"><div class=\"iframely-responsive\" style=\"height: 140px; padding-bottom: 0;\"><a href=\"https://semanariouniversidad.com/pais/con-880-homicidios-2024-cerro-como-el-segundo-ano-mas-violento-de-la-historia/\" data-iframely-url=\"//cdn.iframe.ly/api/iframe?card=small&url=http%3A%2F%2Fsemanariouniversidad.com%2Fpais%2Fcon-880-homicidios-2024-cerro-como-el-segundo-ano-mas-violento-de-la-historia%2F&key=82791205449a6b87420b0f7a75017b28\"></a></div></div><script async src=\"//cdn.iframe.ly/embed.js\" charset=\"utf-8\"></script>\n<br>\n<iframe style=\"border-radius:12px\" src=\"https://open.spotify.com/embed/episode/08JtqQzvLNuXolKz4gm4oF?utm_source=generator\" width=\"100%\" height=\"152\" frameBorder=\"0\" allowfullscreen=\"\" allow=\"autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture\" loading=\"lazy\"></iframe>\n<br>\n<br>\n<div class=\"iframely-embed\"><div class=\"iframely-responsive\" style=\"height: 140px; padding-bottom: 0;\"><a href=\"https://www.nacion.com/sucesos/crimenes/costa-rica-supera-100-homicidios-en-apenas-42-dias/4IYB2XIVJVHJDDLVONXBPHJR7E/story/\" data-iframely-url=\"//cdn.iframe.ly/api/iframe?card=small&url=https%3A%2F%2Fwww.nacion.com%2Fsucesos%2Fcrimenes%2Fcosta-rica-supera-100-homicidios-en-apenas-42-dias%2F4IYB2XIVJVHJDDLVONXBPHJR7E%2Fstory%2F&key=82791205449a6b87420b0f7a75017b28\"></a></div></div><script async src=\"//cdn.iframe.ly/embed.js\" charset=\"utf-8\"></script>\n<br>\n\nCreo que es fundamental que, como ciudadanos, tengamos acceso a la informaci贸n para que podamos comprobar de manera independiente los datos que nos bombardean desde todas partes. No me malentiendan, no se trata de negar las instituciones ni de estar en contra de la prensa, para nada, sino de poder, dentro de lo posible, acceder a las fuentes y echar un vistazo a lo que pasa en el pa铆s, incluso m谩s como un ejercicio de empat铆a que informativo.\n\nCon esa idea en mente, surge este mini tutorial, en el cual mostrar茅, paso a paso, c贸mo utilizar R para descargar y unificar la informaci贸n proporcionada por el [Poder Judicial](https://pjenlinea3.poder-judicial.go.cr/estadisticasoij/).\n\n\n## Automatizar la descarga\n\nEl primer problema se present贸 cuando not茅 que la [plataforma](https://pjenlinea3.poder-judicial.go.cr/estadisticasoij/) solo permite descargar los datos un a帽o a la vez (o al menos a m铆 me da error si intento descargar varios a帽os juntos). Hacerlo manualmente para 10 a帽os no era mi opci贸n preferida. Soy de ese tipo de persona que prefiere pasar dos horas automatizando una tarea que podr铆a hacerse en 15 minutos manualmente. Eso debe tener un nombre o, como m铆nimo, estar tipificado en el DSM-5.\n\nPara lograr esto, vamos a utilizar los paquetes [selenider](https://ashbythorpe.github.io/selenider/index.html) y [chromote](https://rstudio.github.io/chromote/), una combinaci贸n que he venido probando desde hace poco con muy buenos resultados, nos permite hacer web scraping de forma sencilla y, adem谩s, resuelve muchos de los problemas que ten铆amos al trabajar con [RSelenium](https://docs.ropensci.org/RSelenium/).\n\n### Selenider en 1 minuto:\n\n1. Levantas una sesi贸n que controla el navegador por defecto, Chrome.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(selenider)\n\nsession <- selenider_session(\n  \"chromote\",\n  timeout = 10,\n  options = chromote_options(headless = FALSE)\n)\n```\n:::\n\n\n\n2. Abrir una url \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nopen_url(\"https://www.r-project.org/\")\n```\n:::\n\n\n\n3. Seleccionas elementos de la web usando CSS o XPath.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# selecciona los elementos con el id css rStudioHeader\nheader <- s(\"#rStudioHeader\") \n```\n:::\n\n\n\n3. Realizas acciones como clic, llenar informaci贸n, hacer scroll, etc.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ns(\".claseBoton\") |>\n  elem_click()\n```\n:::\n\n\n\n1. `elem_click()`\n\nRealiza un clic en el elemento especificado.\n\n2. `elem_right_click()`\n\nEjecuta un clic derecho sobre el elemento.\n\n3. `elem_double_click()`\n\nRealiza un doble clic en el elemento.\n\n4. `elem_hover()`\n\nPosiciona el cursor sobre el elemento, simulando la acci贸n de pasar el mouse por encima.\n\n5. `elem_scroll_to()`\n\nDesplaza la vista hasta el elemento indicado, lo cual es 煤til si el elemento no est谩 visible antes de realizar un clic o interacci贸n.\n\nVeamos c贸mo es el proceso manual para identificar qu茅 es lo que debemos automatizar:\n\n1. Indicar las fechas de inicio y fin.\n\n![](images/fechas_oij.png){width=35%}\n\n2. Indicar el lugar del suceso.\n\n![](images/lugar_suceso.png){width=35%}\n\n3. Seleccionar la categor铆a delictiva.\n\n![](images/categoria_delictiva.png){width=35%}\n\n4. Indicar si se trata de v铆ctima policial.\n\n![](images/victima_policial.png){width=35%}\n\n5. Hacer clic en el bot贸n de descargar Excel.\n\n![](images/guardar_excel.png){width=35%}\n\n> Ac谩 me qued茅 pegado en un buen rato intentando como explicar el c贸digo, y llegu茅 a la conclusi贸n de que lo m谩s razonable es un video corto.\n\n<div style=\"padding:56.25% 0 0 0;position:relative;\"><iframe src=\"https://player.vimeo.com/video/710119524?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479\" frameborder=\"0\" allow=\"autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media\" style=\"position:absolute;top:0;left:0;width:100%;height:100%;\" title=\"The Art of Work\"></iframe></div><script src=\"https://player.vimeo.com/api/player.js\"></script>\n\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Puedes ver el c贸digo completo ac谩.\"}\nlibrary(rvest)\nlibrary(selenider)\nlibrary(lubridate)\nlibrary(fs)\nlibrary(purrr)\nlibrary(janitor)\nlibrary(glue)\nlibrary(chromote)\nlibrary(dplyr)\nlibrary(readr)\nlibrary(stringr)\n\nwait_for_download <- function(download_dir, filename, timeout = 60) {\n  start_time <- Sys.time()\n  file_path <- file.path(download_dir, filename)\n  while (\n    as.numeric(difftime(Sys.time(), start_time, units = \"secs\")) <= timeout\n  ) {\n    if (\n      file.exists(file_path) &&\n        length(list.files(download_dir, pattern = \"\\\\.crdownload$\")) == 0\n    ) {\n      return(TRUE)\n    }\n    Sys.sleep(1)\n  }\n  cli::cli_abort(\"Se acab贸 el tiempo de espera\")\n}\n\ndownload_dataset_pj <- function(\n  date = lubridate::today(),\n  download_dir = \"data\",\n  filename = \"Estadisticas.xls\"\n) {\n  dir.create(download_dir, showWarnings = FALSE, recursive = TRUE)\n  full_path <- file.path(download_dir, filename)\n\n  session <- selenider_session(\n    \"chromote\",\n    timeout = 10,\n    options = chromote_options(headless = TRUE)\n  )\n  session$driver$Browser$setDownloadBehavior(\n    behavior = \"allow\",\n    downloadPath = normalizePath(download_dir)\n  )\n\n  open_url(\"https://pjenlinea3.poder-judicial.go.cr/estadisticasoij/\")\n\n  start_date <- format(date, \"%d/%m/%Y\")\n  end_date <- update(date, month = 12, day = 31)\n  end_date <- if_else(end_date > today(), today(), end_date)\n  end_date <- format(end_date, \"%d/%m/%Y\")\n\n  execute_js_expr(\n    \"document.getElementById('txtFechaFinal').removeAttribute('readonly',0);\"\n  )\n  execute_js_expr(glue(\n    \"document.getElementById('txtFechaFinal').value = '{end_date}';\",\n  ))\n\n  execute_js_expr(\n    \"document.getElementById('txtFechaInicio').removeAttribute('readonly',0);\"\n  )\n  execute_js_expr(glue(\n    \"document.getElementById('txtFechaInicio').value = '{start_date}';\",\n  ))\n\n  execute_js_expr(\"document.getElementById('chbTodoPais').click();\")\n  execute_js_expr(\"document.getElementById('chbTodoDelitos').click();\")\n  execute_js_expr(\"document.getElementById('chbTodaVictima').click();\")\n\n  execute_js_expr(\"document.getElementById('btnExcel').click();\")\n\n  wait_for_download(download_dir, filename)\n\n  new_filename <- paste0(\"delitos_\", format(date, \"%Y-%m-%d\"), \".html\")\n  new_path <- file.path(download_dir, new_filename)\n  fs::file_move(full_path, new_path)\n\n  return(new_path)\n}\n\n.years <- ymd(\"2025-01-01\") - years(0:11)\n\ndf <- map(\n  .years,\n  \\(x) {\n    .file <- download_dataset_pj(date = x)\n    df <- read_html(.file) |>\n      html_table()\n    df <- df[[1]]\n    return(df)\n  },\n  .progress = TRUE\n) |>\n  list_rbind()\n\ndf |>\n  clean_names() |>\n  mutate(\n    across(where(is.character), str_to_title),\n    fecha = ymd(fecha)\n  ) |>\n  readr::write_rds(glue(\"data/delitos_{today()}.rds\"))\n```\n:::\n\n\n\n## Problemas con el archivo descargado \n\nLuego de hacer la descarga apareci贸 un problema. Al intentar abrir el archivo desde R, me encontr茅 con un error, el archivo parec铆a corrupto o mal formateado. Era raro, porque si abr铆a el archivo directamente desde Excel, todo funcionaba bien.\n\nRevisando el c贸digo fuente de la web, pude encontrar que el archivo se genera a partir de una tabla `HTML` que se codifica en `Base64`, asign谩ndole la extensi贸n `.xls` y un MIME type de Excel *(Excel viejito).* Esto quiere decir que, aunque se pretende que sea un archivo de Excel, el contenido real es HTML y no el formato binario nativo de Excel (xls). Excel, que siempre que puede resuelve, logra detectar ese contenido y mostrar la tabla correctamente, pero el paquete `readxl`, que utiliza la librer铆a `libxls`, requiere espec铆ficamente el formato binario de Excel para poder abrirlo. Por eso, al intentar abrirlo en R se produce el error *libxls error: Unable to open file*, porque, **sorpresa, 隆no es un archivo de Excel!**\n\nLa soluci贸n fue sencilla, si se trata de un archivo `HTML`, basta con cambiarle la extensi贸n de `.xls` a `.html` y usar la funci贸n `read_html` del paquete `rvest`. Una vez resuelto esto, qued贸 completamente automatizado el proceso de descarga de 10 a帽os de registros en un clic.\n\n## Limpieza y normalizaci贸n de los datos\n\nA partir de aqu铆, el trabajo de limpieza es muy corto. Se normalizan los nombres de las columnas y, adem谩s, se ajustan las variables de tipo texto para evitar tenerlas 煤nicamente en may煤sculas.\n\nAqu铆, alguien podr铆a preguntarse: 驴por qu茅, entonces, no descargar directamente el archivo `.csv` y listo? Pasa que, por alg煤n motivo, al archivo `CSV` le falta la columna `distrito`. Asumo que est谩 relacionado con la forma en que se genera a partir de la tabla HTML original, pero, la verdad, no lo investigu茅.\n\nPuedes descargar los datos en el siguiente enlace [descargar datos](../data/delitos_2025-03-03.zip)\n\n## 驴Y ahora qu茅?\n\nEsta ser铆a la primera parte del trabajo. Ahora que tenemos los datos, estamos listos para realizar un an谩lisis. En el siguiente post hablaremos sobre el tema de los homicidios en Costa Rica, su evoluci贸n, y podremos salir de la duda que inici贸 todo: 驴es realmente el aumento de la inseguridad solo un tema de percepci贸n (como hace un tiempo dec铆a un ministro en un podcast) Spoiler:\n\n![](https://mystickermania.com/cdn/stickers/memes/bugs-bunnys-no-meme-512x512.png){width=35%}\n\nFinalmente, un reconocimiento especial al Poder Judicial por el esfuerzo y la transparencia de poner estos datos a disposici贸n de la ciudadan铆a, sin embargo, es importante mencionar que la plataforma todav铆a tiene puntos destacables de mejora.\n\n隆Nos vemos en ese pr贸ximo post!",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}